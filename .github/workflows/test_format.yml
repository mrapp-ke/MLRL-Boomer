name: 'Check code style'
on:
  push:
    paths:
      - '.github/workflows/test_format.yml'
      - 'scons/**'
      - '**/*.hpp'
      - '**/*.cpp'
      - '**/*.py'
      - '.clang-format'
      - '.isort.cfg'
      - '.pylintrc'
      - '.style.yapf'
jobs:
  test_format:
    name: Check code style
    runs-on: ubuntu-latest
    steps:
      - name: Look up Git repository in cache
        uses: actions/cache/restore@v3
        with:
          path: .git/
          key: test-format-cache-git-${{ github.run_id }}
          restore-keys: |
            - test-format-cache-git
      - name: Checkout
        uses: actions/checkout@v4
      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            cpp: &cpp
              - 'scons/**'
              - '**/*.hpp'
              - '**/*.cpp'
              - '.clang-format'
            python: &python
              - 'scons/**'
              - '**/*.py'
              - '.isort.cfg'
              - '.pylintrc'
              - '.style.yapf'
            any:
              - *cpp
              - *python
      - name: Look up build files in cache
        uses: actions/cache/restore@v3
        if: steps.filter.outputs.any == 'true'
        with:
          path: |
            - venv/
            - scons/build/
          key: test-format-cache-tmp-files-${{ github.run_id }}
          restore-keys: |
            - test-format-cache-tmp-files
      - name: Check C++ code style
        if: steps.filter.outputs.cpp == 'true'
        run: ./build test_format_cpp
      - name: Check Python code style
        if: steps.filter.outputs.python == 'true'
        run: ./build test_format_python
      - name: Save build files to cache
        uses: actions/cache/save@v3
        if: (success() || failure()) && steps.filter.outputs.any == 'true'
        with:
          path: |
            - venv/
            - scons/build/
          key: test-format-cache-tmp-files-${{ github.run_id }}
          restore-keys: |
            - test-format-cache-tmp-files
      - name: Save Git repository to cache
        uses: actions/cache/save@v3
        if: success() || failure()
        with:
          path: .git/
          key: test-format-cache-git-${{ github.run_id }}
          restore-keys: |
            - test-format-cache-git
